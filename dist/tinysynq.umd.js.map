{"version":3,"file":"tinysynq.umd.js","sources":["../src/lib/tinysynq.class.ts","../src/lib/index.ts","../src/lib/env.ts","../src/lib/server.ts","../src/index.ts"],"sourcesContent":["import DB from 'better-sqlite3';\nimport { TinySynqSync, TinySynqOptions, createHybridAdapter } from '@bspeckco/tinysynq-lib';\n\n/**\n * The main class for managing SQLite3 synchronisation.\n *\n * @remarks\n * Expects SQLite3 version \\>=3.45.1\n *\n * @public\n */\nexport class TinySynq extends TinySynqSync {\n\n  /**\n   * Configure new TinySynq instance.\n   *\n   * @param opts - Configuration options\n   */\n  constructor(opts: TinySynqOptions) {\n    // If adapter not provided, create one from better-sqlite3\n    if (!opts.adapter) {\n      if (!opts.filePath && !opts.sqlite3) {\n        throw new Error('No DB filePath or connection provided');\n      }\n\n      const db = opts.sqlite3 || new DB(opts.filePath!);\n\n      // Set WAL mode before creating adapter\n      if (opts.wal !== false) {\n        db.pragma('journal_mode = WAL');\n      }\n\n      const adapter = createHybridAdapter({\n        driver: 'better-sqlite3',\n        db,\n        closeOnDispose: !opts.sqlite3, // Only close if we created it\n      });\n\n      opts = { ...opts, adapter };\n    }\n\n    super(opts);\n  }\n}\n","import { Logger } from \"tslog\";\nimport { TinySynq } from \"./tinysynq.class.js\";\nimport { TinySynqOptions, bootstrapTinySynqSync } from \"@bspeckco/tinysynq-lib\";\n\n/**\n * Returns a configured instance of TinySynq\n * \n * @param config - Configuration object \n * @returns TinySynq instance\n * \n * @public\n */\nconst initTinySynq = (config: TinySynqOptions) => {\n  const {\n    tables,\n    preInit,\n    postInit,\n    logOptions,\n    debug,\n  } = config;\n\n  if (!tables?.length) throw new Error('Syncable table data required');\n\n  const log = new Logger({ name: 'tinysynq-setup', ...logOptions });\n  const ts = new TinySynq(config);\n\n  return bootstrapTinySynqSync({\n    ts,\n    options: config,\n    logger: log,\n  });\n};\n\nexport default initTinySynq;\n","import 'dotenv/config'\n\ntype TinySynqEnv = typeof process.env & {\n  TINYSYNQ_WS_HOST: number;\n  TINYSYNQ_WS_PORT: number;\n  TINYSYNQ_HTTP_HOST: number;\n  TINYSYNQ_HTTP_PORT: number;\n  TINYSYNQ_LOG_LEVEL: number;\n  TINYSYNQ_LOG_FORMAT: \"json\" | \"pretty\" | \"hidden\";\n};\n\nexport const env = process.env as TinySynqEnv;","import { env } from './env.js';\nimport * as uWS from 'uWebSockets.js';\nimport { threadId } from 'worker_threads';\nimport { TinySynq } from './tinysynq.class.js';\nimport { Change, LogLevel, SyncRequestType, SyncResponseType, TinySynqTelemetryEmitter } from '@bspeckco/tinysynq-lib';\nimport { ILogObj, ISettingsParam, Logger } from 'tslog';\n\n\ninterface TSTemplatedApp extends uWS.TemplatedApp {\n  ts: TinySynq;\n  log: Logger<ILogObj>;\n  auth?: (req: uWS.HttpRequest) => Promise<boolean | Record<string, any>>;\n  telemetry?: TinySynqTelemetryEmitter;\n}\n\nexport type SocketRequestType = SyncRequestType; \n\nexport interface TSServerParams {\n  ts: TinySynq;\n  port?: number;\n  logOptions: ISettingsParam<ILogObj>;\n  auth?: (req: uWS.HttpRequest) => Promise<boolean | Record<string, any>>; // Handles auth during upgrade (headers/cookies)\n  telemetry?: TinySynqTelemetryEmitter;\n}\n\n// Represents incoming push/pull requests (from tinysynq-lib)\nexport interface TSSocketRequestParams {\n  changes?: Change[];\n  requestId?: string;\n  source?: string;\n  type: SyncRequestType; // From lib (push/pull)\n  since: string;\n  checkpoint: number;\n}\n\n// User data attached to each WebSocket connection\ninterface WebSocketUserData {\n  remoteAddress: string;\n  // No longer need isAuthenticated flag\n  [key: string]: any; // Allow storing arbitrary data from auth functions\n}\n\nfunction arrayBufferToString(arrBuff: ArrayBuffer): string {\n  return Buffer.from(arrBuff).toString();\n} \n\nconst app = uWS.App({}) as TSTemplatedApp;\n\napp.ws<WebSocketUserData>('/*', { // Specify UserData type here\n  compression: uWS.SHARED_COMPRESSOR,\n  maxPayloadLength: 16 * 1024 * 1024,\n  idleTimeout: 120,\n  sendPingsAutomatically: true,\n\n  upgrade: async (res, req, context) => {\n    const secWebSocketKey = req.getHeader('sec-websocket-key');\n    const secWebSocketProtocol = req.getHeader('sec-websocket-protocol');\n    const secWebSocketExtensions = req.getHeader('sec-websocket-extensions');\n    const remoteAddress = arrayBufferToString(res.getRemoteAddressAsText());\n\n    res.onAborted(() => {\n      app.log.warn(`Connection aborted for ${remoteAddress}`);\n      res.aborted = true;\n    });\n\n    let userData: WebSocketUserData = { remoteAddress }; // Base user data\n    \n    try {\n      if (app.auth) {\n        // Perform authentication using the provided auth function\n        app.log.debug(`Performing auth for ${remoteAddress}`);\n        const authResult = await app.auth(req);\n\n        if (authResult === true) {\n          app.log.debug(`Auth successful (true) for ${remoteAddress}`);\n          // Proceed to upgrade, userData only contains remoteAddress unless modified by auth fn later\n        } else if (typeof authResult === 'object' && authResult !== null) {\n          app.log.debug(`Auth successful (object) for ${remoteAddress}`, authResult);\n          // Merge returned user data\n          Object.assign(userData, authResult);\n        } else {\n          // Auth failed (false, null, undefined, etc.)\n          app.log.warn(`Auth failed for ${remoteAddress} (result: ${JSON.stringify(authResult)}), denying connection.`);\n          res.cork(() => {\n             res.writeStatus('401 Unauthorized').end();\n          });\n          return; // Stop processing\n        }\n      } else {\n        // No auth function configured, allow connection\n        app.log.trace(`No auth configured, allowing connection for ${remoteAddress}`);\n      }\n\n      // If we reach here, authentication passed or was not required.\n      app.log.debug(`Upgrading connection for ${remoteAddress}, userData:`, userData);\n      if (!res.aborted) {\n        res.cork(() => {\n          res.upgrade(\n            userData,\n            secWebSocketKey,\n            secWebSocketProtocol,\n            secWebSocketExtensions,\n            context\n          );\n        });\n      } else {\n         app.log.warn(`Upgrade aborted for ${remoteAddress} during auth.`);\n      }\n\n    } catch (err: any) {\n      // Error during auth function execution\n      app.log.error(`Auth error during upgrade for ${remoteAddress}: ${err.message}`);\n      if (!res.aborted) {\n        res.cork(() => {\n            res.writeStatus('500 Internal Server Error').end();\n        });\n      }\n    }\n  },\n\n  open: (ws) => {\n    const userData = ws.getUserData();\n    app.log.warn('@Connected!', userData);\n    app.telemetry?.emit({\n      type: 'hub.connection.open',\n      data: {\n        remoteAddress: userData.remoteAddress,\n      },\n    });\n    ws.subscribe('broadcast');\n  },\n\n  message: async (ws, message, isBinary) => {\n    const userData = ws.getUserData();\n    const remoteAddress = userData.remoteAddress;\n    let parsed: any;\n\n    try {\n      // Ensure message is parsed safely\n      try {\n        const messageString = arrayBufferToString(message);\n        parsed = JSON.parse(messageString);\n      } catch (parseError: any) {\n        app.log.warn(`Failed to parse message from ${remoteAddress}: ${parseError.message}`);\n        ws.close(); // Close connection on parse error\n        return;\n      }\n\n      app.log.trace(`Raw message from ${remoteAddress}:`, parsed);\n      app.telemetry?.emit({\n        type: 'hub.message.received',\n        data: {\n          remoteAddress,\n          requestId: parsed?.requestId,\n          type: parsed?.type,\n        },\n      });\n\n      // --- Handle Authenticated Connections (All connections are considered authenticated here) ---\n      // Ensure the message type is a valid SyncRequestType before proceeding\n      if (typeof parsed.type !== 'string' || !(Object.values(SyncRequestType).includes(parsed.type as SyncRequestType))) {\n        app.log.warn('INVALID_MESSAGE_TYPE received', { parsed, remoteAddress });\n        ws.send(JSON.stringify({ type: SyncResponseType.nack, requestId: parsed?.requestId, message: `Invalid message type: ${parsed?.type}` }));\n        return;\n      }\n\n      const syncRequestParams = parsed as TSSocketRequestParams;\n      app.log.warn('@syncRequestParams', syncRequestParams, '/syncRequestParams');\n      const { requestId } = syncRequestParams;\n      app.log.debug(`@Message (${remoteAddress})!`, syncRequestParams.changes, app.ts.deviceId);\n\n      switch(syncRequestParams.type) {\n        case SyncRequestType.push:\n          if (!syncRequestParams.source) {\n            app.log.error('INVALID_SOURCE', {parsed: syncRequestParams, remoteAddress});\n            throw new Error('Invalid source');\n          }  \n          const incoming = syncRequestParams.changes?.map((c: any) => {\n            c.source = syncRequestParams.source;\n            delete c.mod;\n            return c as Change;\n          }) || [];\n          app.log.debug('\\n<<<< INCOMING >>>>\\n', incoming);\n          app.telemetry?.emit({\n            type: 'hub.push.received',\n            data: {\n              remoteAddress,\n              requestId,\n              changeCount: incoming.length,\n              source: syncRequestParams.source,\n            },\n          });\n          \n          try {\n            app.ts.applyChangesToLocalDB({changes: incoming});\n          }\n          catch(err) {\n          app.log.error('Error applying changes to local DB', {error: err, changes: incoming});\n          ws.send(JSON.stringify({type: SyncResponseType.nack, requestId, message: 'Error applying changes to local DB'}));\n          app.telemetry?.emit({\n            type: 'hub.push.error',\n            data: {\n              remoteAddress,\n              requestId,\n              changeCount: incoming.length,\n              error: err instanceof Error ? err.message : String(err),\n            },\n          });\n          }\n\n          ws.send(JSON.stringify({type: SyncResponseType.ack, requestId}));\n          ws.publish('broadcast', JSON.stringify({changes: incoming, source: syncRequestParams.source}), false);\n          app.telemetry?.emit({\n            type: 'hub.push.applied',\n            data: {\n              remoteAddress,\n              requestId,\n              changeCount: incoming.length,\n              source: syncRequestParams.source,\n            },\n          });\n          break;\n        case SyncRequestType.pull:\n          app.log.warn('@pull: syncRequestParams', syncRequestParams, '/pull');\n          const params = { ...syncRequestParams } as any;\n          delete params?.type;\n          const changes = await app.ts.getFilteredChanges(syncRequestParams); \n          app.log.debug('@pull: outgoing:', changes);\n          ws.send(JSON.stringify({type: SyncResponseType.ack, requestId, changes}));\n          app.telemetry?.emit({\n            type: 'hub.pull.sent',\n            data: {\n              remoteAddress,\n              requestId,\n              changeCount: Array.isArray(changes) ? changes.length : 0,\n              since: syncRequestParams.since,\n              checkpoint: syncRequestParams.checkpoint,\n            },\n          });\n          break;\n        default:\n          throw new Error(`Invalid request type on connection: '${syncRequestParams.type}'`);\n      }\n      \n    } catch(err: any) {\n      // General error handling for message processing\n      app.log.error(`Top-level message handler error for ${remoteAddress}: ${err.message}`, { error: err, parsed });\n      try {\n         ws.send(JSON.stringify({\n           type: SyncResponseType.nack, \n           requestId: parsed?.requestId,\n           message: `Server error processing message: ${err.message}`\n         }));\n      } catch (sendError: any) {\n          app.log.warn(`Failed to send error NACK to ${remoteAddress}, connection likely closed: ${sendError.message}`);\n      }\n      app.telemetry?.emit({\n        type: 'hub.message.error',\n        data: {\n          remoteAddress,\n          requestId: parsed?.requestId,\n          error: err instanceof Error ? err.message : String(err),\n        },\n      });\n       ws.close();\n    }\n  },\n  close: (ws, code, message) => {\n    const userData = ws.getUserData();\n    app.telemetry?.emit({\n      type: 'hub.connection.close',\n      data: {\n        remoteAddress: userData.remoteAddress,\n        code,\n        message: Buffer.from(message).toString(),\n      },\n    });\n  }\n\n});\n\nexport interface TinySynqServerControl {\n  app: TSTemplatedApp;\n  close: () => void;\n}\n\nexport const startTinySynqServer = (params: TSServerParams): TinySynqServerControl => {\n  app.log = new Logger({\n    name:'tinysynq-node-ws',\n    minLevel: params.logOptions.minLevel || Number(env.TINYSYNQ_LOG_LEVEL) || LogLevel.Info,\n    type: env.TINYSYNQ_LOG_FORMAT ?? 'json',\n    ...(params.logOptions || {})\n  });\n  app.log.info(`TinySynq server starting...`);\n  \n  let listenSocket: uWS.us_listen_socket | null = null;\n  const port = params.port || Number(env.TINYSYNQ_WS_PORT) || 7174;\n\n  if (params.telemetry) {\n    params.ts.setTelemetryEmitter(params.telemetry);\n  }\n  app.ts = params.ts;\n  app.auth = params.auth;\n  app.telemetry = params.telemetry;\n\n  app.listen(port, socket => {\n    listenSocket = socket;\n    if (listenSocket) {\n      app.log.info(`TinySynq server listening on port ${port} from thread ${threadId}`);\n    } else {\n      app.log.error(`Failed to listen on port ${port} from thread ${threadId}`);\n    }\n  });\n\n  return {\n    app,\n    close: () => {\n      if (listenSocket) {\n        app.log.info(`Closing server socket on port ${port}`);\n        uWS.us_listen_socket_close(listenSocket);\n        listenSocket = null;\n      } else {\n        app.log.warn(`Attempted to close server, but socket was not listening or already closed.`);\n      }\n    }\n  };\n}\n","import lib from './lib/index.js';\nimport { startTinySynqServer } from './lib/server.js';\n\nexport default { startTinySynqServer, initTinySynq: lib };\n\nexport type { \n  BetterSqlite3Instance,\n} from './lib/types.js';\n\nexport type {\n  SyncableTable,\n  TinySynqOptions,\n  GetTableIdColumnParams,\n  Change,\n  QueryParams,\n} from '@bspeckco/tinysynq-lib';\n\nexport type {\n  TinySynq,\n} from './lib/tinysynq.class.js';\n"],"names":["TinySynq","TinySynqSync","constructor","opts","adapter","filePath","sqlite3","Error","db","DB","wal","pragma","createHybridAdapter","driver","closeOnDispose","initTinySynq","config","tables","preInit","postInit","logOptions","debug","length","log","Logger","name","ts","bootstrapTinySynqSync","options","logger","env","process","arrayBufferToString","arrBuff","Buffer","from","toString","app","uWS","App","ws","compression","SHARED_COMPRESSOR","maxPayloadLength","idleTimeout","sendPingsAutomatically","upgrade","res","req","context","secWebSocketKey","getHeader","secWebSocketProtocol","secWebSocketExtensions","remoteAddress","getRemoteAddressAsText","onAborted","warn","aborted","userData","auth","authResult","Object","assign","JSON","stringify","cork","writeStatus","end","trace","err","error","message","open","_app$telemetry","getUserData","telemetry","emit","type","data","subscribe","isBinary","_syncRequestParams$ch","_app$telemetry3","_app$telemetry5","_app$telemetry6","parsed","_app$telemetry2","_parsed","_parsed2","messageString","parse","parseError","close","requestId","values","SyncRequestType","includes","_parsed3","_parsed4","send","SyncResponseType","nack","syncRequestParams","changes","deviceId","push","source","incoming","map","c","mod","changeCount","applyChangesToLocalDB","_app$telemetry4","String","ack","publish","pull","params","getFilteredChanges","Array","isArray","since","checkpoint","_app$telemetry7","_parsed6","_parsed5","sendError","code","_app$telemetry8","startTinySynqServer","_env$TINYSYNQ_LOG_FOR","minLevel","Number","TINYSYNQ_LOG_LEVEL","LogLevel","Info","TINYSYNQ_LOG_FORMAT","info","listenSocket","port","TINYSYNQ_WS_PORT","setTelemetryEmitter","listen","socket","threadId","us_listen_socket_close","lib"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;EAGA;;;;;;;EAOG;EACG,MAAOA,QAAS,SAAQC,wBAAY,CAAA;EAExC;;;;EAIG;IACHC,WAAAA,CAAYC,IAAqB,EAAA;EAC/B;EACA,IAAA,IAAI,CAACA,IAAI,CAACC,OAAO,EAAE;QACjB,IAAI,CAACD,IAAI,CAACE,QAAQ,IAAI,CAACF,IAAI,CAACG,OAAO,EAAE;EACnC,QAAA,MAAM,IAAIC,KAAK,CAAC,uCAAuC,CAAC,CAAA;EAC1D,OAAA;EAEA,MAAA,MAAMC,EAAE,GAAGL,IAAI,CAACG,OAAO,IAAI,IAAIG,sBAAE,CAACN,IAAI,CAACE,QAAS,CAAC,CAAA;EAEjD;EACA,MAAA,IAAIF,IAAI,CAACO,GAAG,KAAK,KAAK,EAAE;EACtBF,QAAAA,EAAE,CAACG,MAAM,CAAC,oBAAoB,CAAC,CAAA;EACjC,OAAA;QAEA,MAAMP,OAAO,GAAGQ,+BAAmB,CAAC;EAClCC,QAAAA,MAAM,EAAE,gBAAgB;UACxBL,EAAE;EACFM,QAAAA,cAAc,EAAE,CAACX,IAAI,CAACG,OAAO;EAC9B,OAAA,CAAC,CAAA;EAEFH,MAAAA,IAAI,GAAG;EAAE,QAAA,GAAGA,IAAI;EAAEC,QAAAA,OAAAA;SAAS,CAAA;EAC7B,KAAA;MAEA,KAAK,CAACD,IAAI,CAAC,CAAA;EACb,GAAA;EACD;;ECvCD;;;;;;;EAOG;EACH,MAAMY,YAAY,GAAIC,MAAuB,IAAI;IAC/C,MAAM;MACJC,MAAM;MACNC,OAAO;MACPC,QAAQ;MACRC,UAAU;EACVC,IAAAA,KAAAA;EACD,GAAA,GAAGL,MAAM,CAAA;EAEV,EAAA,IAAI,EAACC,MAAM,IAANA,IAAAA,IAAAA,MAAM,CAAEK,MAAM,CAAE,EAAA,MAAM,IAAIf,KAAK,CAAC,8BAA8B,CAAC,CAAA;EAEpE,EAAA,MAAMgB,GAAG,GAAG,IAAIC,YAAM,CAAC;EAAEC,IAAAA,IAAI,EAAE,gBAAgB;MAAE,GAAGL,UAAAA;EAAU,GAAE,CAAC,CAAA;EACjE,EAAA,MAAMM,EAAE,GAAG,IAAI1B,QAAQ,CAACgB,MAAM,CAAC,CAAA;EAE/B,EAAA,OAAOW,iCAAqB,CAAC;MAC3BD,EAAE;EACFE,IAAAA,OAAO,EAAEZ,MAAM;EACfa,IAAAA,MAAM,EAAEN,GAAAA;EACT,GAAA,CAAC,CAAA;EACJ,CAAC;;ECpBM,MAAMO,GAAG,GAAGC,OAAO,CAACD,GAAkB;;EC+B7C,SAASE,mBAAmBA,CAACC,OAAoB,EAAA;IAC/C,OAAOC,MAAM,CAACC,IAAI,CAACF,OAAO,CAAC,CAACG,QAAQ,EAAE,CAAA;EACxC,CAAA;EAEA,MAAMC,GAAG,GAAGC,cAAG,CAACC,GAAG,CAAC,EAAE,CAAmB,CAAA;EAEzCF,GAAG,CAACG,EAAE,CAAoB,IAAI,EAAE;IAC9BC,WAAW,EAAEH,cAAG,CAACI,iBAAiB;EAClCC,EAAAA,gBAAgB,EAAE,EAAE,GAAG,IAAI,GAAG,IAAI;EAClCC,EAAAA,WAAW,EAAE,GAAG;EAChBC,EAAAA,sBAAsB,EAAE,IAAI;IAE5BC,OAAO,EAAE,OAAOC,GAAG,EAAEC,GAAG,EAAEC,OAAO,KAAI;EACnC,IAAA,MAAMC,eAAe,GAAGF,GAAG,CAACG,SAAS,CAAC,mBAAmB,CAAC,CAAA;EAC1D,IAAA,MAAMC,oBAAoB,GAAGJ,GAAG,CAACG,SAAS,CAAC,wBAAwB,CAAC,CAAA;EACpE,IAAA,MAAME,sBAAsB,GAAGL,GAAG,CAACG,SAAS,CAAC,0BAA0B,CAAC,CAAA;MACxE,MAAMG,aAAa,GAAGtB,mBAAmB,CAACe,GAAG,CAACQ,sBAAsB,EAAE,CAAC,CAAA;MAEvER,GAAG,CAACS,SAAS,CAAC,MAAK;QACjBnB,GAAG,CAACd,GAAG,CAACkC,IAAI,CAA2B,CAAAH,uBAAAA,EAAAA,aAAe,EAAA,CAAC,CAAA;QACvDP,GAAG,CAACW,OAAO,GAAG,IAAI,CAAA;EACpB,KAAC,CAAC,CAAA;EAEF,IAAA,IAAIC,QAAQ,GAAsB;EAAEL,MAAAA,aAAAA;EAAe,KAAA,CAAC;MAEpD,IAAI;QACF,IAAIjB,GAAG,CAACuB,IAAI,EAAE;EACZ;UACAvB,GAAG,CAACd,GAAG,CAACF,KAAK,CAAwB,CAAAiC,oBAAAA,EAAAA,aAAe,EAAA,CAAC,CAAA;UACrD,MAAMO,UAAU,GAAG,MAAMxB,GAAG,CAACuB,IAAI,CAACZ,GAAG,CAAC,CAAA;UAEtC,IAAIa,UAAU,KAAK,IAAI,EAAE;YACvBxB,GAAG,CAACd,GAAG,CAACF,KAAK,CAA+B,CAAAiC,2BAAAA,EAAAA,aAAe,EAAA,CAAC,CAAA;EAC5D;WACD,MAAM,IAAI,OAAOO,UAAU,KAAK,QAAQ,IAAIA,UAAU,KAAK,IAAI,EAAE;YAChExB,GAAG,CAACd,GAAG,CAACF,KAAK,CAAiC,gCAAAiC,aAAe,CAAA,CAAA,EAAEO,UAAU,CAAC,CAAA;EAC1E;EACAC,UAAAA,MAAM,CAACC,MAAM,CAACJ,QAAQ,EAAEE,UAAU,CAAC,CAAA;EACrC,SAAC,MAAM;EACL;EACAxB,UAAAA,GAAG,CAACd,GAAG,CAACkC,IAAI,EAAoBH,gBAAAA,EAAAA,aAAa,CAAaU,UAAAA,EAAAA,IAAI,CAACC,SAAS,CAACJ,UAAU,CAAC,wBAAwB,CAAC,CAAA;YAC7Gd,GAAG,CAACmB,IAAI,CAAC,MAAK;cACXnB,GAAG,CAACoB,WAAW,CAAC,kBAAkB,CAAC,CAACC,GAAG,EAAE,CAAA;EAC5C,WAAC,CAAC,CAAA;EACF,UAAA,OAAO;EACT,SAAA;EACF,OAAC,MAAM;EACL;UACA/B,GAAG,CAACd,GAAG,CAAC8C,KAAK,CAAgD,CAAAf,4CAAAA,EAAAA,aAAe,EAAA,CAAC,CAAA;EAC/E,OAAA;EAEA;QACAjB,GAAG,CAACd,GAAG,CAACF,KAAK,CAA6B,4BAAAiC,aAA0B,CAAA,WAAA,CAAA,EAAEK,QAAQ,CAAC,CAAA;EAC/E,MAAA,IAAI,CAACZ,GAAG,CAACW,OAAO,EAAE;UAChBX,GAAG,CAACmB,IAAI,CAAC,MAAK;EACZnB,UAAAA,GAAG,CAACD,OAAO,CACTa,QAAQ,EACRT,eAAe,EACfE,oBAAoB,EACpBC,sBAAsB,EACtBJ,OAAO,CACR,CAAA;EACH,SAAC,CAAC,CAAA;EACJ,OAAC,MAAM;UACJZ,GAAG,CAACd,GAAG,CAACkC,IAAI,CAAwB,CAAAH,oBAAAA,EAAAA,aAA4B,eAAA,CAAC,CAAA;EACpE,OAAA;OAED,CAAC,OAAOgB,GAAQ,EAAE;EACjB;EACAjC,MAAAA,GAAG,CAACd,GAAG,CAACgD,KAAK,CAAC,CAAA,8BAAA,EAAiCjB,aAAa,CAAA,EAAA,EAAKgB,GAAG,CAACE,OAAO,CAAA,CAAE,CAAC,CAAA;EAC/E,MAAA,IAAI,CAACzB,GAAG,CAACW,OAAO,EAAE;UAChBX,GAAG,CAACmB,IAAI,CAAC,MAAK;YACVnB,GAAG,CAACoB,WAAW,CAAC,2BAA2B,CAAC,CAACC,GAAG,EAAE,CAAA;EACtD,SAAC,CAAC,CAAA;EACJ,OAAA;EACF,KAAA;KACD;IAEDK,IAAI,EAAGjC,EAAE,IAAI;EAAA,IAAA,IAAAkC,cAAA,CAAA;EACX,IAAA,MAAMf,QAAQ,GAAGnB,EAAE,CAACmC,WAAW,EAAE,CAAA;MACjCtC,GAAG,CAACd,GAAG,CAACkC,IAAI,CAAC,aAAa,EAAEE,QAAQ,CAAC,CAAA;MACrC,CAAAe,cAAA,GAAArC,GAAG,CAACuC,SAAS,KAAbF,IAAAA,IAAAA,cAAA,CAAeG,IAAI,CAAC;EAClBC,MAAAA,IAAI,EAAE,qBAAqB;EAC3BC,MAAAA,IAAI,EAAE;UACJzB,aAAa,EAAEK,QAAQ,CAACL,aAAAA;EACzB,OAAA;EACF,KAAA,CAAC,CAAA;EACFd,IAAAA,EAAE,CAACwC,SAAS,CAAC,WAAW,CAAC,CAAA;KAC1B;IAEDR,OAAO,EAAE,OAAOhC,EAAE,EAAEgC,OAAO,EAAES,QAAQ,KAAI;EAAA,IAAA,IAAAC,qBAAA,EAAAC,eAAA,EAAAC,eAAA,EAAAC,eAAA,CAAA;EACvC,IAAA,MAAM1B,QAAQ,GAAGnB,EAAE,CAACmC,WAAW,EAAE,CAAA;EACjC,IAAA,MAAMrB,aAAa,GAAGK,QAAQ,CAACL,aAAa,CAAA;EAC5C,IAAA,IAAIgC,MAAW,CAAA;MAEf,IAAI;EAAA,MAAA,IAAAC,eAAA,EAAAC,OAAA,EAAAC,QAAA,CAAA;EACF;QACA,IAAI;EACF,QAAA,MAAMC,aAAa,GAAG1D,mBAAmB,CAACwC,OAAO,CAAC,CAAA;EAClDc,QAAAA,MAAM,GAAGtB,IAAI,CAAC2B,KAAK,CAACD,aAAa,CAAC,CAAA;SACnC,CAAC,OAAOE,UAAe,EAAE;EACxBvD,QAAAA,GAAG,CAACd,GAAG,CAACkC,IAAI,CAAC,CAAA,6BAAA,EAAgCH,aAAa,CAAA,EAAA,EAAKsC,UAAU,CAACpB,OAAO,CAAA,CAAE,CAAC,CAAA;EACpFhC,QAAAA,EAAE,CAACqD,KAAK,EAAE,CAAC;EACX,QAAA,OAAA;EACF,OAAA;QAEAxD,GAAG,CAACd,GAAG,CAAC8C,KAAK,CAAqB,oBAAAf,aAAgB,CAAA,CAAA,CAAA,EAAEgC,MAAM,CAAC,CAAA;QAC3D,CAAAC,eAAA,GAAAlD,GAAG,CAACuC,SAAS,KAAbW,IAAAA,IAAAA,eAAA,CAAeV,IAAI,CAAC;EAClBC,QAAAA,IAAI,EAAE,sBAAsB;EAC5BC,QAAAA,IAAI,EAAE;YACJzB,aAAa;EACbwC,UAAAA,SAAS,GAAAN,OAAA,GAAEF,MAAM,KAANE,IAAAA,GAAAA,KAAAA,CAAAA,GAAAA,OAAA,CAAQM,SAAS;EAC5BhB,UAAAA,IAAI,GAAAW,QAAA,GAAEH,MAAM,KAAA,IAAA,GAAA,KAAA,CAAA,GAANG,QAAA,CAAQX,IAAAA;EACf,SAAA;EACF,OAAA,CAAC,CAAA;EAEF;EACA;QACA,IAAI,OAAOQ,MAAM,CAACR,IAAI,KAAK,QAAQ,IAAI,CAAEhB,MAAM,CAACiC,MAAM,CAACC,2BAAe,CAAC,CAACC,QAAQ,CAACX,MAAM,CAACR,IAAuB,CAAE,EAAE;UAAA,IAAAoB,QAAA,EAAAC,QAAA,CAAA;EACjH9D,QAAAA,GAAG,CAACd,GAAG,CAACkC,IAAI,CAAC,+BAA+B,EAAE;YAAE6B,MAAM;EAAEhC,UAAAA,aAAAA;EAAa,SAAE,CAAC,CAAA;EACxEd,QAAAA,EAAE,CAAC4D,IAAI,CAACpC,IAAI,CAACC,SAAS,CAAC;YAAEa,IAAI,EAAEuB,4BAAgB,CAACC,IAAI;EAAER,UAAAA,SAAS,GAAAI,QAAA,GAAEZ,MAAM,KAANY,IAAAA,GAAAA,KAAAA,CAAAA,GAAAA,QAAA,CAAQJ,SAAS;YAAEtB,OAAO,EAAE,yBAAA,CAAA2B,QAAA,GAAyBb,MAAM,KAAA,IAAA,GAAA,KAAA,CAAA,GAANa,QAAA,CAAQrB,IAAI,CAAA,CAAA;EAAI,SAAA,CAAC,CAAC,CAAA;EACxI,QAAA,OAAA;EACF,OAAA;QAEA,MAAMyB,iBAAiB,GAAGjB,MAA+B,CAAA;QACzDjD,GAAG,CAACd,GAAG,CAACkC,IAAI,CAAC,oBAAoB,EAAE8C,iBAAiB,EAAE,oBAAoB,CAAC,CAAA;QAC3E,MAAM;EAAET,QAAAA,SAAAA;EAAW,OAAA,GAAGS,iBAAiB,CAAA;EACvClE,MAAAA,GAAG,CAACd,GAAG,CAACF,KAAK,CAAC,CAAA,UAAA,EAAaiC,aAAiB,CAAA,EAAA,CAAA,EAAEiD,iBAAiB,CAACC,OAAO,EAAEnE,GAAG,CAACX,EAAE,CAAC+E,QAAQ,CAAC,CAAA;QAEzF,QAAOF,iBAAiB,CAACzB,IAAI;UAC3B,KAAKkB,2BAAe,CAACU,IAAI;EACvB,UAAA,IAAI,CAACH,iBAAiB,CAACI,MAAM,EAAE;EAC7BtE,YAAAA,GAAG,CAACd,GAAG,CAACgD,KAAK,CAAC,gBAAgB,EAAE;EAACe,cAAAA,MAAM,EAAEiB,iBAAiB;EAAEjD,cAAAA,aAAAA;EAAa,aAAC,CAAC,CAAA;EAC3E,YAAA,MAAM,IAAI/C,KAAK,CAAC,gBAAgB,CAAC,CAAA;EACnC,WAAA;EACA,UAAA,MAAMqG,QAAQ,GAAG,CAAA1B,CAAAA,qBAAA,GAAAqB,iBAAiB,CAACC,OAAO,KAAA,IAAA,GAAA,KAAA,CAAA,GAAzBtB,qBAAA,CAA2B2B,GAAG,CAAEC,CAAM,IAAI;EACzDA,YAAAA,CAAC,CAACH,MAAM,GAAGJ,iBAAiB,CAACI,MAAM,CAAA;cACnC,OAAOG,CAAC,CAACC,GAAG,CAAA;EACZ,YAAA,OAAOD,CAAW,CAAA;aACnB,CAAC,KAAI,EAAE,CAAA;YACRzE,GAAG,CAACd,GAAG,CAACF,KAAK,CAAC,wBAAwB,EAAEuF,QAAQ,CAAC,CAAA;YACjD,CAAAzB,eAAA,GAAA9C,GAAG,CAACuC,SAAS,KAAbO,IAAAA,IAAAA,eAAA,CAAeN,IAAI,CAAC;EAClBC,YAAAA,IAAI,EAAE,mBAAmB;EACzBC,YAAAA,IAAI,EAAE;gBACJzB,aAAa;gBACbwC,SAAS;gBACTkB,WAAW,EAAEJ,QAAQ,CAACtF,MAAM;gBAC5BqF,MAAM,EAAEJ,iBAAiB,CAACI,MAAAA;EAC3B,aAAA;EACF,WAAA,CAAC,CAAA;YAEF,IAAI;EACFtE,YAAAA,GAAG,CAACX,EAAE,CAACuF,qBAAqB,CAAC;EAACT,cAAAA,OAAO,EAAEI,QAAAA;EAAS,aAAA,CAAC,CAAA;aAClD,CACD,OAAMtC,GAAG,EAAE;EAAA,YAAA,IAAA4C,eAAA,CAAA;EACX7E,YAAAA,GAAG,CAACd,GAAG,CAACgD,KAAK,CAAC,oCAAoC,EAAE;EAACA,cAAAA,KAAK,EAAED,GAAG;EAAEkC,cAAAA,OAAO,EAAEI,QAAAA;EAAQ,aAAC,CAAC,CAAA;EACpFpE,YAAAA,EAAE,CAAC4D,IAAI,CAACpC,IAAI,CAACC,SAAS,CAAC;gBAACa,IAAI,EAAEuB,4BAAgB,CAACC,IAAI;gBAAER,SAAS;EAAEtB,cAAAA,OAAO,EAAE,oCAAA;EAAoC,aAAC,CAAC,CAAC,CAAA;cAChH,CAAA0C,eAAA,GAAA7E,GAAG,CAACuC,SAAS,KAAbsC,IAAAA,IAAAA,eAAA,CAAerC,IAAI,CAAC;EAClBC,cAAAA,IAAI,EAAE,gBAAgB;EACtBC,cAAAA,IAAI,EAAE;kBACJzB,aAAa;kBACbwC,SAAS;kBACTkB,WAAW,EAAEJ,QAAQ,CAACtF,MAAM;kBAC5BiD,KAAK,EAAED,GAAG,YAAY/D,KAAK,GAAG+D,GAAG,CAACE,OAAO,GAAG2C,MAAM,CAAC7C,GAAG,CAAA;EACvD,eAAA;EACF,aAAA,CAAC,CAAA;EACF,WAAA;EAEA9B,UAAAA,EAAE,CAAC4D,IAAI,CAACpC,IAAI,CAACC,SAAS,CAAC;cAACa,IAAI,EAAEuB,4BAAgB,CAACe,GAAG;EAAEtB,YAAAA,SAAAA;EAAU,WAAA,CAAC,CAAC,CAAA;YAChEtD,EAAE,CAAC6E,OAAO,CAAC,WAAW,EAAErD,IAAI,CAACC,SAAS,CAAC;EAACuC,YAAAA,OAAO,EAAEI,QAAQ;cAAED,MAAM,EAAEJ,iBAAiB,CAACI,MAAAA;aAAO,CAAC,EAAE,KAAK,CAAC,CAAA;YACrG,CAAAvB,eAAA,GAAA/C,GAAG,CAACuC,SAAS,KAAbQ,IAAAA,IAAAA,eAAA,CAAeP,IAAI,CAAC;EAClBC,YAAAA,IAAI,EAAE,kBAAkB;EACxBC,YAAAA,IAAI,EAAE;gBACJzB,aAAa;gBACbwC,SAAS;gBACTkB,WAAW,EAAEJ,QAAQ,CAACtF,MAAM;gBAC5BqF,MAAM,EAAEJ,iBAAiB,CAACI,MAAAA;EAC3B,aAAA;EACF,WAAA,CAAC,CAAA;EACF,UAAA,MAAA;UACF,KAAKX,2BAAe,CAACsB,IAAI;YACvBjF,GAAG,CAACd,GAAG,CAACkC,IAAI,CAAC,0BAA0B,EAAE8C,iBAAiB,EAAE,OAAO,CAAC,CAAA;EACpE,UAAA,MAAMgB,MAAM,GAAG;cAAE,GAAGhB,iBAAAA;aAA0B,CAAA;EACvCgB,UAAAA,MAAM,IAAb,IAAA,IAAA,OAAOA,MAAM,CAAEzC,IAAI,CAAA;YACnB,MAAM0B,OAAO,GAAG,MAAMnE,GAAG,CAACX,EAAE,CAAC8F,kBAAkB,CAACjB,iBAAiB,CAAC,CAAA;YAClElE,GAAG,CAACd,GAAG,CAACF,KAAK,CAAC,kBAAkB,EAAEmF,OAAO,CAAC,CAAA;EAC1ChE,UAAAA,EAAE,CAAC4D,IAAI,CAACpC,IAAI,CAACC,SAAS,CAAC;cAACa,IAAI,EAAEuB,4BAAgB,CAACe,GAAG;cAAEtB,SAAS;EAAEU,YAAAA,OAAAA;EAAQ,WAAA,CAAC,CAAC,CAAA;YACzE,CAAAnB,eAAA,GAAAhD,GAAG,CAACuC,SAAS,KAAbS,IAAAA,IAAAA,eAAA,CAAeR,IAAI,CAAC;EAClBC,YAAAA,IAAI,EAAE,eAAe;EACrBC,YAAAA,IAAI,EAAE;gBACJzB,aAAa;gBACbwC,SAAS;EACTkB,cAAAA,WAAW,EAAES,KAAK,CAACC,OAAO,CAAClB,OAAO,CAAC,GAAGA,OAAO,CAAClF,MAAM,GAAG,CAAC;gBACxDqG,KAAK,EAAEpB,iBAAiB,CAACoB,KAAK;gBAC9BC,UAAU,EAAErB,iBAAiB,CAACqB,UAAAA;EAC/B,aAAA;EACF,WAAA,CAAC,CAAA;EACF,UAAA,MAAA;EACF,QAAA;YACE,MAAM,IAAIrH,KAAK,CAAC,CAAA,qCAAA,EAAwCgG,iBAAiB,CAACzB,IAAO,GAAA,CAAC,CAAA;EACtF,OAAA;OAED,CAAC,OAAMR,GAAQ,EAAE;QAAA,IAAAuD,eAAA,EAAAC,QAAA,CAAA;EAChB;EACAzF,MAAAA,GAAG,CAACd,GAAG,CAACgD,KAAK,CAAwC,CAAA,oCAAA,EAAAjB,kBAAkBgB,GAAG,CAACE,OAAS,CAAA,CAAA,EAAE;EAAED,QAAAA,KAAK,EAAED,GAAG;EAAEgB,QAAAA,MAAAA;EAAQ,OAAA,CAAC,CAAA;QAC7G,IAAI;EAAA,QAAA,IAAAyC,QAAA,CAAA;EACDvF,QAAAA,EAAE,CAAC4D,IAAI,CAACpC,IAAI,CAACC,SAAS,CAAC;YACrBa,IAAI,EAAEuB,4BAAgB,CAACC,IAAI;EAC3BR,UAAAA,SAAS,GAAAiC,QAAA,GAAEzC,MAAM,KAANyC,IAAAA,GAAAA,KAAAA,CAAAA,GAAAA,QAAA,CAAQjC,SAAS;EAC5BtB,UAAAA,OAAO,EAAE,CAAA,iCAAA,EAAoCF,GAAG,CAACE,OAAS,CAAA,CAAA;EAC3D,SAAA,CAAC,CAAC,CAAA;SACL,CAAC,OAAOwD,SAAc,EAAE;EACrB3F,QAAAA,GAAG,CAACd,GAAG,CAACkC,IAAI,CAAC,CAAA,6BAAA,EAAgCH,aAAa,CAAA,4BAAA,EAA+B0E,SAAS,CAACxD,OAAO,CAAA,CAAE,CAAC,CAAA;EACjH,OAAA;QACA,CAAAqD,eAAA,GAAAxF,GAAG,CAACuC,SAAS,KAAbiD,IAAAA,IAAAA,eAAA,CAAehD,IAAI,CAAC;EAClBC,QAAAA,IAAI,EAAE,mBAAmB;EACzBC,QAAAA,IAAI,EAAE;YACJzB,aAAa;EACbwC,UAAAA,SAAS,GAAAgC,QAAA,GAAExC,MAAM,KAANwC,IAAAA,GAAAA,KAAAA,CAAAA,GAAAA,QAAA,CAAQhC,SAAS;YAC5BvB,KAAK,EAAED,GAAG,YAAY/D,KAAK,GAAG+D,GAAG,CAACE,OAAO,GAAG2C,MAAM,CAAC7C,GAAG,CAAA;EACvD,SAAA;EACF,OAAA,CAAC,CAAA;QACD9B,EAAE,CAACqD,KAAK,EAAE,CAAA;EACb,KAAA;KACD;EACDA,EAAAA,KAAK,EAAEA,CAACrD,EAAE,EAAEyF,IAAI,EAAEzD,OAAO,KAAI;EAAA,IAAA,IAAA0D,eAAA,CAAA;EAC3B,IAAA,MAAMvE,QAAQ,GAAGnB,EAAE,CAACmC,WAAW,EAAE,CAAA;MACjC,CAAAuD,eAAA,GAAA7F,GAAG,CAACuC,SAAS,KAAbsD,IAAAA,IAAAA,eAAA,CAAerD,IAAI,CAAC;EAClBC,MAAAA,IAAI,EAAE,sBAAsB;EAC5BC,MAAAA,IAAI,EAAE;UACJzB,aAAa,EAAEK,QAAQ,CAACL,aAAa;UACrC2E,IAAI;UACJzD,OAAO,EAAEtC,MAAM,CAACC,IAAI,CAACqC,OAAO,CAAC,CAACpC,QAAQ,EAAE;EACzC,OAAA;EACF,KAAA,CAAC,CAAA;EACJ,GAAA;EAED,CAAA,CAAC,CAAA;EAOK,MAAM+F,mBAAmB,GAAIZ,MAAsB,IAA2B;EAAA,EAAA,IAAAa,qBAAA,CAAA;EACnF/F,EAAAA,GAAG,CAACd,GAAG,GAAG,IAAIC,YAAM,CAAC;EACnBC,IAAAA,IAAI,EAAC,kBAAkB;EACvB4G,IAAAA,QAAQ,EAAEd,MAAM,CAACnG,UAAU,CAACiH,QAAQ,IAAIC,MAAM,CAACxG,GAAG,CAACyG,kBAAkB,CAAC,IAAIC,oBAAQ,CAACC,IAAI;MACvF3D,IAAI,EAAA,CAAAsD,qBAAA,GAAEtG,GAAG,CAAC4G,mBAAmB,KAAA,IAAA,GAAAN,qBAAA,GAAI,MAAM;EACvC,IAAA,IAAIb,MAAM,CAACnG,UAAU,IAAI,EAAE,CAAA;EAC5B,GAAA,CAAC,CAAA;EACFiB,EAAAA,GAAG,CAACd,GAAG,CAACoH,IAAI,CAAC,6BAA6B,CAAC,CAAA;IAE3C,IAAIC,YAAY,GAAgC,IAAI,CAAA;EACpD,EAAA,MAAMC,IAAI,GAAGtB,MAAM,CAACsB,IAAI,IAAIP,MAAM,CAACxG,GAAG,CAACgH,gBAAgB,CAAC,IAAI,IAAI,CAAA;IAEhE,IAAIvB,MAAM,CAAC3C,SAAS,EAAE;MACpB2C,MAAM,CAAC7F,EAAE,CAACqH,mBAAmB,CAACxB,MAAM,CAAC3C,SAAS,CAAC,CAAA;EACjD,GAAA;EACAvC,EAAAA,GAAG,CAACX,EAAE,GAAG6F,MAAM,CAAC7F,EAAE,CAAA;EAClBW,EAAAA,GAAG,CAACuB,IAAI,GAAG2D,MAAM,CAAC3D,IAAI,CAAA;EACtBvB,EAAAA,GAAG,CAACuC,SAAS,GAAG2C,MAAM,CAAC3C,SAAS,CAAA;EAEhCvC,EAAAA,GAAG,CAAC2G,MAAM,CAACH,IAAI,EAAEI,MAAM,IAAG;EACxBL,IAAAA,YAAY,GAAGK,MAAM,CAAA;EACrB,IAAA,IAAIL,YAAY,EAAE;QAChBvG,GAAG,CAACd,GAAG,CAACoH,IAAI,CAAsC,qCAAAE,IAAoB,CAAA,aAAA,EAAAK,uBAAU,CAAA,CAAA,CAAC,CAAA;EACnF,KAAC,MAAM;QACL7G,GAAG,CAACd,GAAG,CAACgD,KAAK,CAA6B,4BAAAsE,IAAoB,CAAA,aAAA,EAAAK,uBAAU,CAAA,CAAA,CAAC,CAAA;EAC3E,KAAA;EACF,GAAC,CAAC,CAAA;IAEF,OAAO;MACL7G,GAAG;MACHwD,KAAK,EAAEA,MAAK;EACV,MAAA,IAAI+C,YAAY,EAAE;UAChBvG,GAAG,CAACd,GAAG,CAACoH,IAAI,CAAkC,CAAAE,8BAAAA,EAAAA,IAAM,EAAA,CAAC,CAAA;EACrDvG,QAAAA,cAAG,CAAC6G,sBAAsB,CAACP,YAAY,CAAC,CAAA;EACxCA,QAAAA,YAAY,GAAG,IAAI,CAAA;EACrB,OAAC,MAAM;EACLvG,QAAAA,GAAG,CAACd,GAAG,CAACkC,IAAI,CAAC,4EAA4E,CAAC,CAAA;EAC5F,OAAA;EACF,KAAA;KACD,CAAA;EACH,CAAC;;ACnUD,cAAe;IAAE0E,mBAAmB;EAAEpH,EAAAA,YAAY,EAAEqI,YAAAA;GAAK;;;;;;;;"}